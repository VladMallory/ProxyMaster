# Система уведомлений о подписке

## Описание

Система уведомлений автоматически отправляет пользователям напоминания о скором истечении подписки. Уведомления настраиваются через конфигурационный файл и работают в фоновом режиме.

## Настройки

Все настройки уведомлений находятся в файле `common/config.go`:

### Основные параметры

- `NOTIFICATION_ENABLED` - включить/выключить систему уведомлений (по умолчанию: `true`)
- `NOTIFICATION_CHECK_INTERVAL` - интервал проверки подписок в минутах (по умолчанию: `60` минут)
- `NOTIFICATION_DAYS_BEFORE` - массив дней до истечения, за которые отправлять уведомления (по умолчанию: `[1, 3, 7]`)

### Сообщения

- `NOTIFICATION_MESSAGE_1_DAY` - сообщение за 1 день до истечения
- `NOTIFICATION_MESSAGE_3_DAYS` - сообщение за 3 дня до истечения  
- `NOTIFICATION_MESSAGE_7_DAYS` - сообщение за 7 дней до истечения

## Архитектура

### Файлы системы

1. **`common/config.go`** - настройки уведомлений
2. **`telegram_bot/notification.go`** - основная логика уведомлений
3. **`common/database.go`** - функции для работы с базой данных и отправки уведомлений

### Основные компоненты

#### NotificationManager
- `NewNotificationManager(bot)` - создание менеджера уведомлений
- `StartNotificationScheduler()` - запуск планировщика проверок
- `CheckUserSubscription(user)` - проверка конкретного пользователя
- `SendImmediateNotification(telegramID, message)` - немедленная отправка уведомления

#### Функции базы данных
- `GetUsersWithActiveConfigs()` - получение всех пользователей с активными подписками
- `CheckUserSubscriptionNotification(user)` - проверка и отправка уведомления пользователю

## Как работает система

1. **Планировщик** запускается при старте бота и работает в фоновом режиме
2. **Периодическая проверка** происходит каждые `NOTIFICATION_CHECK_INTERVAL` минут
3. **Фильтрация пользователей** - система проверяет только пользователей с активными подписками
4. **Расчет дней** - вычисляется количество дней до истечения подписки
5. **Отправка уведомлений** - если количество дней совпадает с настройками, отправляется соответствующее сообщение

## Интеграция

### Автоматическая интеграция

Система автоматически интегрирована в:
- **Создание подписки** - при успешном создании/продлении подписки
- **Пробный период** - при активации пробного периода
- **Планировщик** - периодическая проверка всех пользователей

### Ручная интеграция

Для отправки уведомления конкретному пользователю:

```go
// Получить пользователя
user, err := common.GetUserByTelegramID(telegramID)
if err != nil {
    return err
}

// Проверить и отправить уведомление
common.CheckUserSubscriptionNotification(user)
```

## Настройка сообщений

Сообщения поддерживают HTML разметку. Пример настройки:

```go
NOTIFICATION_MESSAGE_1_DAY = "⚠️ <b>Ваша подписка истекает завтра!</b>\n\n" +
    "Не забудьте продлить подписку, чтобы не потерять доступ к VPN.\n\n" +
    "Нажмите /balance для просмотра баланса и продления."
```

## Логирование

Все действия системы логируются с префиксом `NOTIFICATION:`:
- Запуск планировщика
- Проверка пользователей
- Отправка уведомлений
- Ошибки отправки

## Тестирование

Для тестирования системы создан файл `test_notifications.go`:

```bash
go run test_notifications.go
```

**Внимание**: Перед тестированием замените `123456789` в файле на реальный Telegram ID.

## Мониторинг

Система выводит в лог:
- Количество проверенных пользователей
- Количество отправленных уведомлений
- Ошибки при отправке
- Статистику работы планировщика

## Отключение системы

Для отключения системы уведомлений установите в `config.go`:

```go
NOTIFICATION_ENABLED = false
```

После изменения конфигурации перезапустите бота.
