# IP Ban System

Система автоматического управления конфигурациями x-ui на основе анализа количества IP адресов.

## Описание

Эта система автоматически:
- **Отключает** конфиги, если с них заходит больше IP адресов, чем разрешено
- **Включает** конфиги, если количество IP адресов в пределах нормы
- Анализирует файл `access.log` x-ui для определения активности

## Установка и запуск

### 1. Переход в папку
```bash
cd /root/bot/ipBan
```

### 2. Запуск сервиса
```bash
go run .
```

### 3. Просмотр статистики
```bash
go run . -stats
```

### 4. Просмотр конфигураций
```bash
go run . -list-configs
```

## Настройка

### Параметры в config.go
```go
IP_BAN_ENABLED = true                    // Включена ли система
MAX_IPS_PER_CONFIG = 2                   // Максимум IP на конфиг
ACCESS_LOG_PATH = "/usr/local/x-ui/access.log" // Путь к логу
IP_CHECK_INTERVAL = 5                    // Интервал проверки (минуты)
IP_BAN_GRACE_PERIOD = 10                 // Период ожидания (минуты)
```

### Параметры командной строки
```bash
go run . -max-ips 3 -check-interval 10m -grace-period 15m
```

## Команды

### Основные команды
- `go run .` - Запуск сервиса мониторинга
- `go run . -stats` - Показать статистику и выйти
- `go run . -list-configs` - Показать все конфиги
- `go run . -enable 123456789` - Включить конфиг по email
- `go run . -disable 123456789` - Отключить конфиг по email

### Параметры
- `-panel-url` - URL панели x-ui
- `-panel-user` - Пользователь панели
- `-panel-pass` - Пароль панели
- `-inbound-id` - ID inbound
- `-access-log` - Путь к access.log
- `-max-ips` - Максимум IP на конфиг
- `-check-interval` - Интервал проверки
- `-grace-period` - Период ожидания

## Принцип работы

1. **Анализ лога**: Система читает `/usr/local/x-ui/access.log`
2. **Группировка по email**: Находит все IP адреса для каждого email
3. **Проверка лимитов**: Сравнивает количество IP с лимитом
4. **Управление конфигами**:
   - Если IP > лимита → отключает конфиг
   - Если IP ≤ лимита → включает конфиг

## Примеры использования

### Запуск с настройками по умолчанию
```bash
go run .
```

### Запуск с кастомными настройками
```bash
go run . -max-ips 3 -check-interval 10m -access-log /custom/path/access.log
```

### Просмотр статистики
```bash
go run . -stats
```

### Управление конкретным конфигом
```bash
# Включить конфиг
go run . -enable 123456789

# Отключить конфиг
go run . -disable 123456789
```

## Логирование

Система выводит подробную информацию о:
- Найденных подозрительных конфигах
- Действиях по включению/отключению
- Статистике по IP адресам
- Ошибках при работе с API

## Автозапуск

Для автозапуска добавьте в crontab:
```bash
# Проверка каждые 5 минут
*/5 * * * * cd /root/bot/ipBan && go run . -stats >> /var/log/ipban.log 2>&1
```

## Безопасность

- Система не изменяет настройки конфигураций, только включает/отключает их
- Все изменения логируются
- Можно легко отключить через `IP_BAN_ENABLED = false`

## Устранение неполадок

### Ошибка "файл access.log не найден"
Проверьте путь в `ACCESS_LOG_PATH` или используйте `-access-log`

### Ошибка "не удается подключиться к панели"
Проверьте настройки панели в `-panel-url`, `-panel-user`, `-panel-pass`

### Конфиги не отключаются
Проверьте права доступа к API панели и правильность `inbound-id`
