# Настройка чеков для ЮКассы (54-ФЗ)

## Проблема
При создании платежа через прямое API ЮКассы возникает ошибка:
```
"Receipt is missing or illegal"
```

Это происходит потому, что согласно требованиям 54-ФЗ, все платежи должны сопровождаться чеками.

## Решение

### 1. Включить отправку чеков
В `common/config.go` установите:
```go
YUKASSA_RECEIPT_ENABLED = true  // Включить отправку чеков
```

### 2. Настроить параметры чека

#### Коды НДС (YUKASSA_VAT_CODE):
- `1` - НДС 20%
- `2` - НДС 10% 
- `3` - НДС 0%
- `4` - Без НДС
- `5` - НДС 20/120
- `6` - НДС 10/110

#### Предметы расчета (YUKASSA_PAYMENT_SUBJECT):
- `service` - Услуга (рекомендуется для VPN)
- `commodity` - Товар
- `excise` - Подакцизный товар
- `job` - Работа
- `gambling_bet` - Ставка в азартной игре
- `gambling_prize` - Выигрыш в азартной игре
- `lottery` - Лотерейный билет
- `lottery_prize` - Выигрыш в лотерее
- `intellectual_activity` - Результат интеллектуальной деятельности
- `payment` - Платеж
- `agent_commission` - Агентское вознаграждение
- `composite` - Составной предмет расчета
- `another` - Другое

#### Способы расчета (YUKASSA_PAYMENT_MODE):
- `full_prepayment` - Полная предоплата (рекомендуется)
- `partial_prepayment` - Частичная предоплата
- `advance` - Аванс
- `full_payment` - Полный расчет
- `partial_payment` - Частичный расчет
- `credit` - Передача в кредит
- `credit_payment` - Оплата кредита

### 3. Пример настройки для VPN-услуг
```go
YUKASSA_RECEIPT_ENABLED = true
YUKASSA_VAT_CODE = 1              // НДС 20%
YUKASSA_PAYMENT_SUBJECT = "service" // Услуга
YUKASSA_PAYMENT_MODE = "full_prepayment" // Полная предоплата
```

### 4. Отключение чеков (не рекомендуется)
Если по каким-то причинам нужно отключить чеки:
```go
YUKASSA_RECEIPT_ENABLED = false
```

⚠️ **Внимание:** Отключение чеков может нарушать требования 54-ФЗ!

## Структура чека

Каждый чек содержит:
- **Customer**: Информация о покупателе (email: `user_{ID}@vpnbot.local`)
- **Items**: Список товаров/услуг
  - Описание услуги
  - Сумма
  - НДС
  - Предмет расчета
  - Способ расчета
  - Количество

## Логирование

Все операции с чеками логируются с префиксом `PAYMENT_API_INFO`:
```
PAYMENT_API_INFO: Создание платежа для пользователя 123456 на сумму 100.00
PAYMENT_API_INFO: Платеж создан: ID=payment_abc123, UserID=123456, Amount=100.00, URL=https://...
```

## Тестирование

1. Убедитесь, что `YUKASSA_RECEIPT_ENABLED = true`
2. Попробуйте создать платеж на 100₽
3. Проверьте логи на наличие ошибок
4. При успешном создании платежа вы получите ссылку на оплату

## Поддержка

Если проблемы сохраняются:
1. Проверьте логи бота
2. Убедитесь в корректности Shop ID и Secret Key
3. Проверьте настройки в личном кабинете ЮКассы
4. Обратитесь в поддержку ЮКассы
